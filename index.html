<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>เกมจับคู่ S. suis พิชิตโรค - 8 ด่าน (Gender & AMR)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- SweetAlert2 CDN -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap');

        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #f0fdf4;
            overscroll-behavior-y: contain;
        }

        /* ปรับ Header ให้เรียบง่ายขึ้นเมื่อไม่มีรูปพื้นหลัง */
        header {
            background-color: white;
            padding: 1rem;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .card-container {
            perspective: 1000px;
        }

        .card {
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.5s;
            cursor: pointer;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .card.flipped {
            transform: rotateY(180deg);
        }

        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 0.5rem;
            text-align: center;
        }

        .card-front {
            background: linear-gradient(135deg, #34d399 0%, #059669 100%);
            color: white;
            font-size: 2rem;
        }

        .card-back {
            background-color: white;
            transform: rotateY(180deg);
            border: 2px solid #059669;
            color: #064e3b;
            font-weight: bold;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .text-content {
            font-size: 0.85rem;
            line-height: 1.3;
        }

        @media (max-width: 640px) {
            .text-content {
                font-size: 0.7rem;
            }
        }

        .matched {
            animation: pulse 0.5s ease-in-out;
        }

        @keyframes pulse {
            0% {
                transform: scale(1) rotateY(180deg);
            }

            50% {
                transform: scale(1.1) rotateY(180deg);
            }

            100% {
                transform: scale(1) rotateY(180deg);
            }
        }

        .level-dot {
            transition: all 0.3s ease;
            width: 2rem;
            height: 2rem;
            min-width: 2rem; /* Prevent shrinking */
        }

        .level-dot.active {
            background-color: #059669;
            color: white;
            border-color: #059669;
            transform: scale(1.1);
        }

        .level-dot.completed {
            background-color: #34d399;
            color: white;
            border-color: #34d399;
        }

        .level-line {
            height: 4px;
            flex-grow: 1;
            background-color: #e5e7eb;
            margin: 0 2px;
            border-radius: 2px;
        }

        .level-line.filled {
            background-color: #34d399;
        }

        /* AI Box Animation */
        .ai-pulse {
            animation: ai-glow 2s infinite;
        }

        @keyframes ai-glow {
            0% {
                box-shadow: 0 0 5px #a7f3d0;
            }

            50% {
                box-shadow: 0 0 15px #34d399;
            }

            100% {
                box-shadow: 0 0 5px #a7f3d0;
            }
        }

        .typing-loader::after {
            content: '...';
            animation: typing 1.5s steps(4, end) infinite;
        }

        @keyframes typing {

            0%,
            100% {
                content: '';
            }

            25% {
                content: '.';
            }

            50% {
                content: '..';
            }

            75% {
                content: '...';
            }
        }
    </style>
</head>

<body class="min-h-screen flex flex-col items-center py-6 px-4 pb-24">

    <!-- Welcome / Instructions Screen -->
    <div id="welcome-screen" class="w-full max-w-2xl bg-white rounded-2xl shadow-xl p-8 mt-4 text-center">
        <div class="w-24 h-24 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
            <i class="fas fa-bacteria text-5xl text-green-600"></i>
        </div>
        <h1 class="text-3xl md:text-4xl font-bold text-green-800 mb-2">S. suis & AMR พิชิตโรค</h1>
        <p class="text-gray-500 mb-8">เกมทดสอบความรู้โรคหูดับและมิติทางสังคม (One Health)</p>

        <div class="bg-green-50 rounded-xl p-6 mb-8 text-left border border-green-200">
            <h2 class="text-xl font-bold text-green-800 mb-4 flex items-center">
                <i class="fas fa-gamepad mr-2 text-green-600"></i> วิธีการเล่นเบื้องต้น
            </h2>
            <ul class="space-y-3 text-gray-700 text-sm md:text-base">
                <li class="flex items-start">
                    <i class="fas fa-bullseye text-red-500 mt-1 mr-2 w-5"></i>
                    <span><strong>เป้าหมาย:</strong> จับคู่การ์ดทั้งหมด 8 ด่าน ครอบคลุมทั้งตัวเชื้อโรค และปัจจัยทางสังคม</span>
                </li>
                <li class="flex items-start">
                    <i class="fas fa-hand-pointer text-blue-500 mt-1 mr-2 w-5"></i>
                    <span><strong>การจับคู่:</strong> หาคู่ระหว่าง <span class="text-orange-600 font-bold">การ์ดคำถาม (สีส้ม)</span> และ <span
                            class="text-green-600 font-bold">การ์ดคำตอบ (สีเขียว)</span></span>
                </li>
                <li class="flex items-start">
                    <i class="fas fa-robot text-purple-500 mt-1 mr-2 w-5"></i>
                    <span><strong>AI Corner:</strong> เกร็ดความรู้จากพี่ AI จะเด้งขึ้นมาอธิบายเมื่อจับคู่ถูก</span>
                </li>
            </ul>
        </div>

        <button onclick="onStartGame()"
            class="bg-green-600 hover:bg-green-700 text-white text-xl font-bold py-4 px-12 rounded-full shadow-lg transform transition hover:scale-105 active:scale-95 w-full md:w-auto">
            <i class="fas fa-play mr-2"></i> เริ่มเกมเลย!
        </button>
    </div>

    <!-- Main Game Container (Initially Hidden) -->
    <div id="game-container" class="w-full flex flex-col items-center hidden">
        <!-- Header & Level Progress -->
        <header class="w-full max-w-4xl mb-6">
            <div class="flex justify-between items-end mb-4">
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold text-green-800">
                        <i class="fas fa-bacteria mr-2"></i>S. suis พิชิตโรค
                    </h1>
                    <p id="level-title" class="text-green-600 text-sm md:text-base font-medium mt-1">ด่านที่ 1:
                        รู้จักเชื้อเบื้องต้น</p>
                </div>

                <div class="flex gap-3 text-sm font-bold text-gray-700">
                    <button onclick="openMultiplayerModal()" id="btn-multiplayer"
                        class="bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-1 rounded-full shadow-sm border border-blue-200 flex items-center transition-colors">
                        <i class="fas fa-users mr-2"></i> <span id="multiplayer-status">เล่นกับเพื่อน</span>
                    </button>
                    <div class="bg-white px-3 py-1 rounded-full shadow-sm border border-green-100 flex items-center">
                        <i class="fas fa-stopwatch mr-2 text-blue-500"></i>
                        <span id="time">00:00</span>
                    </div>
                    <div class="bg-white px-3 py-1 rounded-full shadow-sm border border-green-100 flex items-center">
                        <i class="fas fa-star mr-2 text-yellow-500"></i>
                        <span id="moves">0</span>
                    </div>
                </div>
            </div>

            <!-- 8 Level Dots Indicator -->
            <div class="flex items-center justify-between px-2 overflow-x-auto pb-2">
                <!-- Dot 1 -->
                <div class="level-dot rounded-full border-2 border-gray-300 flex items-center justify-center font-bold text-gray-400 text-xs active" id="dot-1">1</div>
                <div class="level-line" id="line-1"></div>
                <!-- Dot 2 -->
                <div class="level-dot rounded-full border-2 border-gray-300 flex items-center justify-center font-bold text-gray-400 text-xs" id="dot-2">2</div>
                <div class="level-line" id="line-2"></div>
                <!-- Dot 3 -->
                <div class="level-dot rounded-full border-2 border-gray-300 flex items-center justify-center font-bold text-gray-400 text-xs" id="dot-3">3</div>
                <div class="level-line" id="line-3"></div>
                <!-- Dot 4 -->
                <div class="level-dot rounded-full border-2 border-gray-300 flex items-center justify-center font-bold text-gray-400 text-xs" id="dot-4">4</div>
                <div class="level-line" id="line-4"></div>
                <!-- Dot 5 -->
                <div class="level-dot rounded-full border-2 border-gray-300 flex items-center justify-center font-bold text-gray-400 text-xs" id="dot-5">5</div>
                <div class="level-line" id="line-5"></div>
                <!-- Dot 6 -->
                <div class="level-dot rounded-full border-2 border-gray-300 flex items-center justify-center font-bold text-gray-400 text-xs" id="dot-6">6</div>
                <div class="level-line" id="line-6"></div>
                <!-- Dot 7 -->
                <div class="level-dot rounded-full border-2 border-gray-300 flex items-center justify-center font-bold text-gray-400 text-xs" id="dot-7">7</div>
                <div class="level-line" id="line-7"></div>
                <!-- Dot 8 -->
                <div class="level-dot rounded-full border-2 border-gray-300 flex items-center justify-center font-bold text-gray-400 text-xs" id="dot-8">8</div>
            </div>
        </header>

        <!-- Game Board -->
        <div id="game-board" class="grid w-full max-w-4xl mx-auto transition-all duration-300 mb-8">
            <!-- Cards will be generated here -->
        </div>

        <!-- AI Knowledge Corner -->
        <div id="ai-corner"
            class="w-full max-w-4xl bg-white rounded-xl shadow-lg border border-green-200 overflow-hidden hidden transition-all duration-500 mt-8">
            <div
                class="bg-gradient-to-r from-green-100 to-emerald-50 p-3 border-b border-green-200 flex justify-between items-center">
                <h3 class="font-bold text-green-800 flex items-center">
                    <i class="fas fa-sparkles text-yellow-500 mr-2"></i>
                    เกร็ดความรู้จากพี่ AI
                </h3>
                <span class="text-xs text-green-600 bg-white px-2 py-1 rounded-full border border-green-100">Powered by
                    Gemini</span>
            </div>
            <div class="p-4">
                <div id="ai-loading" class="hidden text-green-600 italic">
                    <i class="fas fa-robot mr-2 animate-bounce"></i> กำลังเรียบเรียงความรู้<span
                        class="typing-loader"></span>
                </div>
                <div id="ai-content" class="hidden">
                    <p id="ai-text" class="text-gray-700 leading-relaxed mb-3"></p>
                    <button onclick="playAIAudio()" id="btn-play-audio"
                        class="text-sm bg-green-100 hover:bg-green-200 text-green-700 py-1 px-3 rounded-full transition-colors flex items-center w-max">
                        <i class="fas fa-volume-up mr-2"></i> ฟังเสียงบรรยาย
                    </button>
                    <div id="audio-loading" class="hidden text-xs text-green-600 mt-1">
                        <i class="fas fa-circle-notch fa-spin mr-1"></i> กำลังสร้างเสียง...
                    </div>
                </div>
                <div id="ai-empty" class="text-gray-400 text-center py-2 text-sm italic">
                    จับคู่ให้ถูกต้องเพื่อปลดล็อกเกร็ดความรู้!
                </div>
            </div>
        </div>

        <!-- Manual Knowledge Box Trigger -->
        <div class="w-full max-w-4xl flex flex-col items-center mt-8 mb-6">
            <button onclick="toggleKnowledgeBox()"
                class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transform transition hover:scale-105 active:scale-95 flex items-center">
                <i class="fas fa-book-open mr-2"></i> คลังความรู้
            </button>

            <div id="manual-knowledge-box"
                class="w-full mt-4 bg-gray-50 rounded-xl shadow-lg border border-indigo-200 hidden transition-all duration-300">
                <!-- Knowledge Hub Container -->
                <div class="p-6">
                    <header class="text-center mb-6">
                        <h2 class="text-2xl font-bold text-indigo-900 mb-2">Knowledge Hub: สุขภาพสัตว์และนวัตกรรม</h2>
                        <p class="text-gray-600 text-sm">รวบรวมองค์ความรู้ด้านการลดใช้ยาปฏิชีวนะและโรคสำคัญในสุกร</p>
                    </header>

                    <!-- Tabs -->
                    <div class="flex flex-col md:flex-row rounded-lg bg-gray-200 p-1 mb-6 shadow-inner gap-1">
                        <button onclick="switchTab('antibiotics')" id="tab-antibiotics"
                            class="flex-1 py-3 px-4 rounded-md text-sm font-semibold transition-all duration-200 bg-white text-indigo-700 shadow-sm">
                            นวัตกรรมทดแทนยาปฏิชีวนะ
                        </button>
                        <button onclick="switchTab('ssuis')" id="tab-ssuis"
                            class="flex-1 py-3 px-4 rounded-md text-sm font-semibold transition-all duration-200 text-gray-600 hover:text-gray-800">
                            โรคสเตรปโตคอคคัส ซูอิส
                        </button>
                        <button onclick="switchTab('gender_amr')" id="tab-gender"
                            class="flex-1 py-3 px-4 rounded-md text-sm font-semibold transition-all duration-200 text-gray-600 hover:text-gray-800">
                            มิติทางเพศ & AMR
                        </button>
                    </div>

                    <!-- Content Header -->
                    <div id="section-header" class="mb-6 text-center">
                        <h2 class="text-lg font-bold text-gray-800 mb-1" id="section-title">นวัตกรรมลดการใช้ยาปฏิชีวนะ
                        </h2>
                        <p class="text-gray-500 text-sm" id="section-subtitle">
                            แนวทางเลือกใหม่เพื่อความยั่งยืนในอุตสาหกรรมปศุสัตว์</p>
                    </div>

                    <!-- Accordion Container -->
                    <div id="accordion-container" class="space-y-2">
                        <!-- Content will be injected here via JS -->
                    </div>

                    <footer class="mt-8 text-center text-gray-400 text-xs">
                        <p>© 2024 Livestock Health Knowledge Base. Based on One Health Concept.</p>
                    </footer>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals (Level & Victory) -->
    <div id="level-modal"
        class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden backdrop-blur-sm">
        <div
            class="bg-white p-8 rounded-2xl shadow-2xl text-center max-w-sm mx-4 transform scale-100 animate-bounce-short">
            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-check text-3xl text-green-600"></i>
            </div>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">ผ่านด่าน <span id="modal-level-num">1</span>!</h2>
            <p class="text-gray-600 mb-4" id="modal-msg">เยี่ยมมาก! พร้อมสำหรับความท้าทายต่อไปหรือยัง?</p>
            <div class="flex justify-center gap-4 mb-6 text-sm">
                <div class="text-gray-500"><i class="fas fa-clock mr-1"></i> <span id="level-time">00:00</span></div>
                <div class="text-gray-500"><i class="fas fa-hand-pointer mr-1"></i> <span id="level-moves">0</span>
                    ครั้ง</div>
            </div>
            <button onclick="nextLevel()"
                class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition duration-300 flex items-center justify-center">
                ไปด่านถัดไป <i class="fas fa-arrow-right ml-2"></i>
            </button>
        </div>
    </div>

    <div id="victory-modal"
        class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden backdrop-blur-md">
        <div class="bg-white p-8 rounded-2xl shadow-2xl text-center max-w-sm mx-4 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-yellow-400 via-orange-500 to-red-500">
            </div>
            <div class="w-20 h-20 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-trophy text-4xl text-yellow-600"></i>
            </div>
            <h2 class="text-3xl font-bold text-gray-800 mb-2">ผู้เชี่ยวชาญ S. suis!</h2>
            <p class="text-gray-600 mb-6">คุณตอบคำถามครบ 8 ด่านและมีความรู้เรื่องโรคและมิติทางสังคมอย่างยอดเยี่ยม</p>
            <div class="bg-gray-50 p-4 rounded-xl mb-6">
                <p class="text-sm text-gray-500 mb-1">เวลารวมทั้งหมด</p>
                <p class="text-2xl font-bold text-green-600" id="total-time">00:00</p>
            </div>
            <button onclick="restartGame()"
                class="w-full bg-gray-800 hover:bg-gray-900 text-white font-bold py-3 px-8 rounded-xl transition duration-300">
                <i class="fas fa-redo mr-2"></i> เล่นใหม่อีกครั้ง
            </button>
        </div>
    </div>

    <!-- Multiplayer Modal -->
    <div id="multiplayer-modal"
        class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden backdrop-blur-sm">
        <div class="bg-white p-6 rounded-2xl shadow-xl max-w-sm w-full mx-4">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-wifi text-blue-500 mr-2"></i> เชื่อมต่อเล่นกับเพื่อน
            </h2>
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2">ชื่อห้อง (Room ID)</label>
                <input type="text" id="room-id-input"
                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                    placeholder="เช่น room123">
                <p class="text-xs text-gray-500 mt-1">เพื่อนต้องใส่ชื่อห้องเดียวกัน</p>
            </div>
            <div class="flex justify-end gap-2">
                <button onclick="document.getElementById('multiplayer-modal').classList.add('hidden')"
                    class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                    ยกเลิก
                </button>
                <button onclick="connectMQTT()"
                    class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                    เชื่อมต่อ
                </button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/paho-mqtt@1.1.0/paho-mqtt.min.js"></script>
    <script>
        // TODO: Insert your Google Gemini API Key here to enable AI features (Explanation & TTS)
        const apiKey = "AIzaSyBBqJqIg6CTShy1mvyD22N9ynaMKGmFeoM";

        // --- Game Data (8 Levels Now) ---
        const levelsData = [
            {
                title: "ด่านที่ 1: รู้จักเชื้อเบื้องต้น",
                pairs: [
                    { id: "1-1", text: "S. suis คือเชื้ออะไร?", icon: "fa-question-circle", type: "q" },
                    { id: "1-1", text: "แบคทีเรียแกรมบวก", icon: "fa-bacterium", type: "a" },
                    { id: "1-2", text: "เชื้อมีรูปร่างอย่างไร?", icon: "fa-question-circle", type: "q" },
                    { id: "1-2", text: "ทรงกลม (Coccus)", icon: "fa-circle", type: "a" },
                    { id: "1-3", text: "เชื้อเคลื่อนที่ได้ไหม?", icon: "fa-question-circle", type: "q" },
                    { id: "1-3", text: "ไม่ได้ (Non-motile)", icon: "fa-ban", type: "a" }
                ]
            },
            {
                title: "ด่านที่ 2: ใครคือเป้าหมาย?",
                pairs: [
                    { id: "2-1", text: "โรคนี้ติดคนได้หรือไม่?", icon: "fa-people-arrows", type: "q" },
                    { id: "2-1", text: "ได้ (Zoonotic Agent)", icon: "fa-check-circle", type: "a" },
                    { id: "2-2", text: "หมูช่วงอายุไหนป่วยง่ายสุด?", icon: "fa-piggy-bank", type: "q" },
                    { id: "2-2", text: "5-10 สัปดาห์", icon: "fa-calendar-week", type: "a" },
                    { id: "2-3", text: "อัตราการตายในหมูเท่าไหร่?", icon: "fa-skull-crossbones", type: "q" },
                    { id: "2-3", text: "ประมาณ 5-20%", icon: "fa-percentage", type: "a" },
                    { id: "2-4", text: "อัตราพาหะในฝูงสูงไหม?", icon: "fa-viruses", type: "q" },
                    { id: "2-4", text: "สูงเกือบ 100%", icon: "fa-chart-pie", type: "a" }
                ]
            },
            {
                title: "ด่านที่ 3: การแพร่เชื้อและสาเหตุ",
                pairs: [
                    { id: "3-1", text: "เชื้อเข้าสู่ร่างกายทางไหน?", icon: "fa-route", type: "q" },
                    { id: "3-1", text: "ทางปากและจมูก", icon: "fa-head-side-mask", type: "a" },
                    { id: "3-2", text: "ปัจจัยใดทำให้หมูป่วยง่าย?", icon: "fa-bolt", type: "q" },
                    { id: "3-2", text: "ความเครียด (Stress)", icon: "fa-tired", type: "a" },
                    { id: "3-3", text: "สภาพเล้าแบบไหนที่เสี่ยง?", icon: "fa-wind", type: "q" },
                    { id: "3-3", text: "การระบายอากาศไม่ดี", icon: "fa-smog", type: "a" },
                    { id: "3-4", text: "สัตว์พาหะมีอะไรบ้าง?", icon: "fa-spider", type: "q" },
                    { id: "3-4", text: "แมลงวัน นก หนู", icon: "fa-crow", type: "a" },
                    { id: "3-5", text: "การเลี้ยงแบบไหนเสี่ยงโรค?", icon: "fa-industry", type: "q" },
                    { id: "3-5", text: "เลี้ยงหนาแน่นเกินไป", icon: "fa-users-slash", type: "a" },
                    { id: "3-6", text: "ระบบผลิตแบบไหนสะสมเชื้อ?", icon: "fa-sync", type: "q" },
                    { id: "3-6", text: "แบบต่อเนื่อง (Continuous)", icon: "fa-arrow-right-arrow-left", type: "a" }
                ]
            },
            {
                title: "ด่านที่ 4: อาการและรอยโรค",
                pairs: [
                    { id: "4-1", text: "อาการที่รุนแรงที่สุดคือ?", icon: "fa-exclamation-circle", type: "q" },
                    { id: "4-1", text: "ตายอย่างเฉียบพลัน", icon: "fa-cross", type: "a" },
                    { id: "4-2", text: "อาการทางประสาทที่สำคัญ?", icon: "fa-brain", type: "q" },
                    { id: "4-2", text: "เยื่อหุ้มสมองอักเสบ", icon: "fa-biohazard", type: "a" },
                    { id: "4-3", text: "ลักษณะการเดินของหมูป่วย?", icon: "fa-walking", type: "q" },
                    { id: "4-3", text: "เดินโซเซ / ขาว่ายน้ำ", icon: "fa-swimmer", type: "a" },
                    { id: "4-4", text: "สังเกตความผิดปกติที่ขา?", icon: "fa-bone", type: "q" },
                    { id: "4-4", text: "ข้ออักเสบ บวม", icon: "fa-crutch", type: "a" },
                    { id: "4-5", text: "ผลกระทบต่อดวงตา?", icon: "fa-eye", type: "q" },
                    { id: "4-5", text: "ตาบอด", icon: "fa-eye-slash", type: "a" },
                    { id: "4-6", text: "ไข้ขึ้นสูงเท่าไหร่?", icon: "fa-thermometer-full", type: "q" },
                    { id: "4-6", text: "105-106 °F", icon: "fa-fire", type: "a" }
                ]
            },
            {
                title: "ด่านที่ 5: พิชิตโรค",
                pairs: [
                    { id: "5-1", text: "ยาปฏิชีวนะหลักคือ?", icon: "fa-pills", type: "q" },
                    { id: "5-1", text: "เพนิซิลลิน", icon: "fa-prescription-bottle", type: "a" },
                    { id: "5-2", text: "ยาทางเลือกคืออะไร?", icon: "fa-capsules", type: "q" },
                    { id: "5-2", text: "อะม็อกซีซิลลิน", icon: "fa-tablets", type: "a" },
                    { id: "5-3", text: "วิธีป้องกันที่ดีที่สุด?", icon: "fa-shield-virus", type: "q" },
                    { id: "5-3", text: "ระบบความปลอดภัยชีวภาพ", icon: "fa-user-shield", type: "a" },
                    { id: "5-4", text: "วิธีกำจัดเชื้อในฟาร์ม?", icon: "fa-pump-soap", type: "q" },
                    { id: "5-4", text: "รักษาสุขอนามัย/ฆ่าเชื้อ", icon: "fa-broom", type: "a" },
                    { id: "5-5", text: "วิธีวินิจฉัยยืนยันโรค?", icon: "fa-vial", type: "q" },
                    { id: "5-5", text: "เพาะเชื้อแบคทีเรีย", icon: "fa-dna", type: "a" },
                    { id: "5-6", text: "อาการคล้ายโรคอะไร?", icon: "fa-random", type: "q" },
                    { id: "5-6", text: "โรคกลาสเซอร์", icon: "fa-notes-medical", type: "a" },
                    { id: "5-7", text: "รอยโรคที่หัวใจคือ?", icon: "fa-heart-broken", type: "q" },
                    { id: "5-7", text: "ลิ้นหัวใจอักเสบ", icon: "fa-heartbeat", type: "a" },
                    { id: "5-8", text: "รอยโรคที่ปอดคือ?", icon: "fa-lungs-virus", type: "q" },
                    { id: "5-8", text: "ปอดบวม", icon: "fa-lungs", type: "a" }
                ]
            },
            // --- NEW LEVELS START HERE ---
            {
                title: "ด่านที่ 6: บทบาททางสังคม (Roles)",
                pairs: [
                    { id: "6-1", text: "ผู้หญิงเตรียมอาหาร", icon: "fa-utensils", type: "q" },
                    { id: "6-1", text: "เสี่ยงรับเชื้อจากเนื้อดิบ", icon: "fa-hand-holding-medical", type: "a" },
                    { id: "6-2", text: "บุคลากรแพทย์ 70% เป็นหญิง", icon: "fa-user-nurse", type: "q" },
                    { id: "6-2", text: "ด่านหน้าเสี่ยงรับเชื้อ", icon: "fa-hospital-user", type: "a" },
                    { id: "6-3", text: "ผู้ชายไปอบรม แต่ใครเลี้ยง?", icon: "fa-chalkboard-teacher", type: "q" },
                    { id: "6-3", text: "ผู้หญิง (ขาดความรู้)", icon: "fa-female", type: "a" }
                ]
            },
            {
                title: "ด่านที่ 7: พฤติกรรมและอคติ (Bias)",
                pairs: [
                    { id: "7-1", text: "ผู้ชายกลัวดูอ่อนแอ", icon: "fa-fist-raised", type: "q" },
                    { id: "7-1", text: "หาหมอช้า / ซื้อยากินเอง", icon: "fa-pills", type: "a" },
                    { id: "7-2", text: "แพทย์กับคนไข้ผู้หญิง", icon: "fa-stethoscope", type: "q" },
                    { id: "7-2", text: "อคติจ่ายยาเกินจำเป็น", icon: "fa-prescription", type: "a" },
                    { id: "7-3", text: "ผู้นำองค์กรชายล้วน", icon: "fa-user-tie", type: "q" },
                    { id: "7-3", text: "นโยบายมองข้ามผู้หญิง", icon: "fa-eye-slash", type: "a" }
                ]
            },
            {
                title: "ด่านที่ 8: โครงสร้างพื้นฐาน (Vulnerability)",
                pairs: [
                    { id: "8-1", text: "เกษตรกรหญิงทุนน้อย", icon: "fa-coins", type: "q" },
                    { id: "8-1", text: "พึ่งยาถูกเพื่อพยุงชีพ", icon: "fa-hand-holding-usd", type: "a" },
                    { id: "8-2", text: "ห้องน้ำไม่สะอาด", icon: "fa-toilet", type: "q" },
                    { id: "8-2", text: "ติดเชื้อ UTI / กินยาบ่อย", icon: "fa-bacteria", type: "a" },
                    { id: "8-3", text: "เด็กเล่นในที่ปนเปื้อน", icon: "fa-child", type: "q" },
                    { id: "8-3", text: "เสี่ยงรับเชื้อสิ่งแวดล้อม", icon: "fa-water", type: "a" },
                    { id: "8-4", text: "ผู้หญิงเป็นผู้ดูแล (Carer)", icon: "fa-hands-helping", type: "q" },
                    { id: "8-4", text: "ขาดเงินซื้อยาคุณภาพ", icon: "fa-money-bill-wave-alt", type: "a" }
                ]
            }
        ];

        // --- Game State ---
        let currentLevelIndex = 0;
        let cards = [];
        let hasFlippedCard = false;
        let lockBoard = false;
        let firstCard, secondCard;
        let moves = 0;
        let matchedPairs = 0;
        let timerInterval;
        let seconds = 0;
        let totalSeconds = 0;
        let gameStarted = false;
        let currentExplanation = "";

        // --- MQTT State ---
        let mqttClient;
        let isMultiplayer = false;
        let roomId = "";
        let isHost = false;
        let myClientId = "client-" + Math.random().toString(16).substr(2, 8);

        // --- DOM Elements ---
        const gameContainer = document.getElementById('game-container');
        const welcomeScreen = document.getElementById('welcome-screen');
        const gameBoard = document.getElementById('game-board');
        const movesDisplay = document.getElementById('moves');
        const timeDisplay = document.getElementById('time');
        const levelTitle = document.getElementById('level-title');
        const levelModal = document.getElementById('level-modal');
        const victoryModal = document.getElementById('victory-modal');

        // AI Elements
        const aiCorner = document.getElementById('ai-corner');
        const aiLoading = document.getElementById('ai-loading');
        const aiContent = document.getElementById('ai-content');
        const aiText = document.getElementById('ai-text');
        const aiEmpty = document.getElementById('ai-empty');
        const audioLoading = document.getElementById('audio-loading');

        // --- Start Game Logic (New) ---
        function onStartGame() {
            // SweetAlert2 Loading
            Swal.fire({
                title: 'กำลังเข้าสู่เกม...',
                html: 'เตรียมตัวให้พร้อม!',
                timer: 1500,
                timerProgressBar: true,
                didOpen: () => {
                    Swal.showLoading()
                },
                willClose: () => {
                    // Transition Logic
                    welcomeScreen.classList.add('hidden');
                    gameContainer.classList.remove('hidden');
                    initGame(0);
                }
            });
        }

        // --- Init Function ---
        function initGame(levelIndex) {
            currentLevelIndex = levelIndex;
            const levelData = levelsData[levelIndex];

            levelTitle.innerText = levelData.title;
            updateLevelIndicator(levelIndex);

            cards = [...levelData.pairs];
            shuffle(cards);
            resetLevelStats();
            renderBoard();

            // Reset AI box for new level
            aiCorner.classList.remove('hidden');
            resetAIBox();
        }

        function toggleKnowledgeBox() {
            const box = document.getElementById('manual-knowledge-box');
            if (box.classList.contains('hidden')) {
                box.classList.remove('hidden');
                setTimeout(() => box.scrollIntoView({ behavior: 'smooth', block: 'center' }), 100);
            } else {
                box.classList.add('hidden');
            }
        }

        function resetAIBox() {
            aiLoading.classList.add('hidden');
            aiContent.classList.add('hidden');
            aiEmpty.classList.remove('hidden');
            aiCorner.classList.remove('ai-pulse');
        }

        function updateLevelIndicator(index) {
            const totalDots = 8;
            for (let i = 0; i < totalDots; i++) {
                const dot = document.getElementById(`dot-${i + 1}`);
                const line = document.getElementById(`line-${i + 1}`);

                dot.className = "level-dot rounded-full border-2 border-gray-300 flex items-center justify-center font-bold text-gray-400 text-xs";
                if (line) line.className = "level-line";

                if (i < index) {
                    dot.classList.add('completed', 'bg-green-400', 'border-green-400', 'text-white');
                    if (line) line.classList.add('filled');
                } else if (i === index) {
                    dot.classList.add('active');
                }
            }
        }

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function renderBoard() {
            gameBoard.innerHTML = '';

            const cardCount = cards.length;
            let gridClass = 'grid-cols-3 gap-3';

            if (cardCount === 6) gridClass = 'grid-cols-3 gap-4';
            if (cardCount === 8) gridClass = 'grid-cols-4 md:grid-cols-4 gap-3';
            if (cardCount >= 12) gridClass = 'grid-cols-3 md:grid-cols-4 gap-2 md:gap-4';
            if (cardCount === 16) gridClass = 'grid-cols-4 gap-2';

            gameBoard.className = `grid ${gridClass} w-full max-w-4xl mx-auto`;

            cards.forEach((item) => {
                const cardElement = document.createElement('div');
                const heightClass = cardCount >= 12 ? 'h-24 md:h-32' : 'h-32 md:h-40';

                // ใช้การกำหนด className ตรงๆ เพื่อความเสถียรสูงสุดในทุก Browser/Webview
                cardElement.className = `card-container w-full ${heightClass}`;

                let bgColorClass = item.type === 'q' ? 'bg-orange-50 border-orange-200' : 'bg-green-50 border-green-200';

                // Remove onclick from HTML string and bind event listener programmatically
                cardElement.innerHTML = `
                    <div class="card w-full h-full" data-id="${item.id}">
                        <div class="card-face card-front rounded-xl shadow-md">
                            <i class="fas fa-question text-white opacity-50"></i>
                        </div>
                        <div class="card-face card-back rounded-xl shadow-md ${bgColorClass}">
                            <i class="fas ${item.icon} text-2xl mb-1 ${item.type === 'q' ? 'text-orange-500' : 'text-green-600'}"></i>
                            <span class="text-content ${item.type === 'q' ? 'text-orange-800' : 'text-green-800'}">${item.text}</span>
                        </div>
                    </div>
                `;

                // Add listener to the .card element inside
                const cardInner = cardElement.querySelector('.card');
                cardInner.addEventListener('click', function () {
                    flipCard(this, true); // true = action by local user
                });

                gameBoard.appendChild(cardElement);
            });
        }

        // --- Gameplay Logic ---
        function flipCard(cardWrapper, isLocalAction = false) {
            const card = cardWrapper;

            if (!gameStarted) {
                startTimer();
                gameStarted = true;
                if (isLocalAction && isMultiplayer) sendGameAction('START_TIMER', {});
            }

            if (lockBoard) return;
            if (card === firstCard) return;
            if (card.classList.contains('flipped')) return;

            // MQTT Sync: Send flip action
            if (isLocalAction && isMultiplayer) {
                const cardIndex = Array.from(gameBoard.children).indexOf(card.parentElement);
                sendGameAction('FLIP', { cardIndex: cardIndex });
            }

            card.classList.add('flipped');

            if (!hasFlippedCard) {
                hasFlippedCard = true;
                firstCard = card;
                return;
            }

            secondCard = card;
            incrementMoves();
            checkForMatch();
        }

        function checkForMatch() {
            let isMatch = firstCard.dataset.id === secondCard.dataset.id;

            if (isMatch) {
                disableCards();
            } else {
                unflipCards();
            }
        }

        function disableCards() {
            const card1 = firstCard;
            const card2 = secondCard;

            setTimeout(() => {
                const back1 = card1.querySelector('.card-back');
                const back2 = card2.querySelector('.card-back');

                back1.classList.remove('bg-orange-50', 'bg-green-50', 'border-orange-200', 'border-green-200');
                back2.classList.remove('bg-orange-50', 'bg-green-50', 'border-orange-200', 'border-green-200');

                back1.classList.add('bg-green-100', 'border-green-500');
                back2.classList.add('bg-green-100', 'border-green-500');

                back1.innerHTML += '<i class="fas fa-check-circle absolute top-1 right-1 text-green-500 text-xs"></i>';
                back2.innerHTML += '<i class="fas fa-check-circle absolute top-1 right-1 text-green-500 text-xs"></i>';
            }, 200);

            // --- TRIGGER AI EXPLANATION ---
            const text1 = firstCard.querySelector('.text-content').innerText;
            const text2 = secondCard.querySelector('.text-content').innerText;
            // Pass the ID from the first card to use backup knowledge
            fetchAIExplanation(text1, text2, firstCard.dataset.id);

            matchedPairs++;
            resetBoard();

            if (matchedPairs === cards.length / 2) {
                setTimeout(levelComplete, 1500);
            }
        }

        function unflipCards() {
            lockBoard = true;
            setTimeout(() => {
                firstCard.classList.remove('flipped');
                secondCard.classList.remove('flipped');
                resetBoard();
            }, 1000);
        }

        function resetBoard() {
            [hasFlippedCard, lockBoard] = [false, false];
            [firstCard, secondCard] = [null, null];
        }

        function incrementMoves() {
            moves++;
            movesDisplay.innerText = moves;
        }

        // --- AI API Logic ---
        const explanationCache = {};

        const backupKnowledge = {
            // ด่าน 1: รู้จักเชื้อ
            "1-1": "S. suis เป็นแบคทีเรียตัวเล็กจิ๋ว ต้องส่องกล้องจุลทรรศน์ถึงจะเห็นนะ",
            "1-2": "เชื้อตัวนี้มีรูปร่าง 'กลม' เหมือนลูกบอลเลย เรียกว่า Coccus",
            "1-3": "เชื้อชนิดนี้ขี้เกียจ ไม่ชอบเคลื่อนที่ไปไหนเอง (Non-motile)",
            // ด่าน 2: เป้าหมาย
            "2-1": "ระวัง! โรคนี้เป็นโรคติดต่อจากสัตว์สู่คน (Zoonosis) อันตรายถึงชีวิต",
            "2-2": "ลูกหมูอนุบาล (5-10 สัปดาห์) ภูมิตกง่าย เลยป่วยบ่อยที่สุด",
            "2-3": "ถ้าหมูป่วย 100 ตัว อาจจะตายได้ถึง 20 ตัวเลยนะ (อัตราตาย 5-20%)",
            "2-4": "หมูเกือบทั้งฝูงอาจมีเชื้อซ่อนอยู่โดยไม่แสดงอาการ เหมือนระเบิดเวลา!",
            // ด่าน 3: การแพร่เชื้อ
            "3-1": "เชื้อเข้าทาง 'ปากและจมูก' เวลาหมูสัมผัสกันหรือกินของสกปรก",
            "3-2": "ความเครียด (Stress) ทำให้หมูอ่อนแอ จนเชื้อโรคโจมตีได้สำเร็จ",
            "3-3": "อากาศในเล้าไม่ถ่ายเท จะสะสมเชื้อโรคไว้เยอะ ทำให้หมูป่วยง่าย",
            "3-4": "แมลงวัน นก และหนู เป็นสายลับพาเชื้อโรคไปติดหมูตัวอื่นได้",
            "3-5": "การเลี้ยงหมูแน่นเกินไป แย่งกันกินแย่งกันอยู่ ทำให้เชื้อแพร่ไวมาก",
            "3-6": "การเลี้ยงต่อเนื่องไม่พักเล้า (All-in All-out) ทำให้เชื้อสะสม ตัดวงจรโรคไม่ได้",
            // ด่าน 4: อาการ
            "4-1": "บางทีหมูอาจตายกะทันหันโดยที่เรายังไม่ทันเห็นอาการเลย",
            "4-2": "เชื้อชอบขึ้นสมอง ทำให้เยื่อหุ้มสมองอักเสบ หมูจะชักเกร็ง",
            "4-3": "หมูจะเดินเซทรงตัวไม่ได้ หรือนอนตะกุยขาเหมือนกำลังว่ายน้ำ",
            "4-4": "เชื้อเข้าไปทำลายข้อต่อ ทำให้ข้อบวมแดง เดินเจ็บขา",
            "4-5": "เชื้อทำลายระบบประสาทตา ทำให้หมูตาบอด มองไม่เห็น",
            "4-6": "หมูจะมีไข้สูงจี๋ถึง 105-106 องศาฟาเรนไฮต์ ตัวร้อนมาก",
            // ด่าน 5: พิชิตโรค
            "5-1": "ยาเพนิซิลลิน (Penicillin) เป็นฮีโร่ปราบเชื้อตัวนี้ได้ดีที่สุด",
            "5-2": "ยาอะม็อกซีซิลลิน (Amoxicillin) ก็ใช้รักษาได้ผลดีเหมือนกัน",
            "5-3": "Biosecurity หรือระบบป้องกันโรค เป็นเกราะวิเศษที่ดีที่สุดของฟาร์ม",
            "5-4": "ต้องหมั่นทำความสะอาดและฆ่าเชื้อในฟาร์มเพื่อกำจัดเชื้อโรค",
            "5-5": "คุณหมอต้องนำเชื้อไปเพาะในห้องแล็บ ถึงจะยืนยันโรคได้ชัวร์ที่สุด",
            "5-6": "อาการคล้ายโรค 'กลาสเซอร์' มาก ต้องให้คุณหมอแยกโรคให้ดี",
            "5-7": "เชื้อเกาะที่ลิ้นหัวใจ ทำให้หัวใจอักเสบ ทำงานผิดปกติ",
            "5-8": "เชื้อลงไปที่ปอด ทำให้ปอดบวม หายใจลำบาก",
            // --- NEW LEVELS: SOCIAL ASPECTS ---
            // ด่าน 6: บทบาททางสังคม
            "6-1": "ผู้หญิงมักเป็นคนทำอาหาร ทำให้เสี่ยงสัมผัสเชื้อจากเนื้อหมูดิบผ่านบาดแผลได้มากกว่า",
            "6-2": "พยาบาลและผู้ดูแลส่วนใหญ่เป็นผู้หญิง ทำให้ต้องใกล้ชิดผู้ป่วยและเสี่ยงรับเชื้อดื้อยา",
            "6-3": "ผู้ชายมักได้ไปอบรม แต่ผู้หญิงเป็นคนเลี้ยงจริง ทำให้ความรู้เรื่องยาไปไม่ถึงคนปฏิบัติงาน",
            // ด่าน 7: พฤติกรรม
            "7-1": "ผู้ชายบางคนกลัวดูอ่อนแอ (Toxic Masculinity) เลยไม่ไปหาหมอ หรือซื้อยากินเองมั่วๆ จนเชื้อดื้อยา",
            "7-2": "แพทย์บางท่านอาจมีอคติ จ่ายยาปฏิชีวนะให้ผู้หญิงง่ายกว่าเพราะคิดว่าอ่อนแอ ทำให้เสี่ยงดื้อยา",
            "7-3": "เมื่อคนกำหนดนโยบายมีแต่ผู้ชาย ปัญหาละเอียดอ่อนของผู้หญิงอาจถูกมองข้ามไป",
            // ด่าน 8: โครงสร้างพื้นฐาน
            "8-1": "เกษตรกรหญิงที่ยากจน ไม่มีทางเลือก ต้องใช้ยาถูกๆ เพื่อพยุงชีพสัตว์ให้รอด",
            "8-2": "ห้องน้ำสกปรกทำให้ผู้หญิงติดเชื้อทางเดินปัสสาวะง่าย นำไปสู่การกินยาฆ่าเชื้อบ่อยเกินจำเป็น",
            "8-3": "เด็กๆ ชอบเล่นดินเล่นน้ำ ซึ่งอาจมีเชื้อดื้อยาตกค้างจากสิ่งแวดล้อม",
            "8-4": "สังคมคาดหวังให้ผู้หญิงดูแลทุกคน แต่ถ้าไม่มีเงิน ก็อาจต้องซื้อยาชุดไม่ได้มาตรฐานมาใช้"
        };

        // --- AI API Logic ---
        async function fetchAIExplanation(term1, term2, pairId) {
            aiEmpty.classList.add('hidden');
            aiContent.classList.add('hidden');
            aiLoading.classList.remove('hidden');
            aiCorner.classList.add('ai-pulse');

            const cacheKey = [term1, term2].sort().join('||');

            if (pairId && backupKnowledge[pairId]) {
                currentExplanation = backupKnowledge[pairId];
                setTimeout(() => displayAIResult(currentExplanation), 500);
                return;
            }

            if (explanationCache[cacheKey]) {
                currentExplanation = explanationCache[cacheKey];
                displayAIResult(currentExplanation);
                return;
            }

            const fallbackText = `ความสัมพันธ์ระหว่าง "${term1}" และ "${term2}" เป็นสิ่งสำคัญในการเข้าใจโรค S. suis และผลกระทบทางสังคม`;

            try {
                const modelName = "gemini-1.5-flash";
                const prompt = `Explain the connection between '${term1}' and '${term2}' regarding Antimicrobial Resistance (AMR) and Gender roles in One Health context. Keep it very short, simple, fun, and educational for a Thai primary student. Max 2 short sentences in Thai language.`;

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });

                if (!response.ok) {
                    throw new Error('API request failed');
                }

                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text;

                if (text) {
                    currentExplanation = text;
                    explanationCache[cacheKey] = text;
                } else {
                    currentExplanation = fallbackText;
                }

            } catch (e) {
                console.error("AI Error:", e);
                currentExplanation = fallbackText + " (ใช้ข้อมูลสำรองเนื่องจากต่อ AI ไม่ได้)";
            }

            displayAIResult(currentExplanation);
        }

        function displayAIResult(text) {
            aiLoading.classList.add('hidden');
            aiCorner.classList.remove('ai-pulse');
            aiContent.classList.remove('hidden');
            aiText.innerText = text;
        }

        async function playAIAudio() {
            if (!currentExplanation) return;

            const btn = document.getElementById('btn-play-audio');
            const loading = document.getElementById('audio-loading');

            btn.disabled = true;
            btn.classList.add('opacity-50');
            loading.classList.remove('hidden');

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: "Say in a teaching tone: " + currentExplanation }] }],
                        generationConfig: {
                            responseModalities: ["AUDIO"],
                            speechConfig: {
                                voiceConfig: {
                                    prebuiltVoiceConfig: {
                                        voiceName: "Aoede"
                                    }
                                }
                            }
                        }
                    })
                });

                if (!response.ok) throw new Error('TTS API Error');
                const data = await response.json();
                const audioBase64 = data.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;

                if (audioBase64) {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const binaryString = atob(audioBase64);
                    const bytes = new Uint8Array(binaryString.length);
                    for (let i = 0; i < binaryString.length; i++) {
                        bytes[i] = binaryString.charCodeAt(i);
                    }

                    const wavBytes = pcm16ToWav(bytes, 24000);
                    const blob = new Blob([wavBytes], { type: 'audio/wav' });
                    const audioUrl = URL.createObjectURL(blob);
                    const audio = new Audio(audioUrl);
                    audio.play();

                    audio.onended = () => {
                        btn.disabled = false;
                        btn.classList.remove('opacity-50');
                    };
                } else {
                    throw new Error("No audio data");
                }
            } catch (e) {
                console.error("TTS Error:", e);
                const utterance = new SpeechSynthesisUtterance(currentExplanation);
                utterance.lang = 'th-TH';
                speechSynthesis.speak(utterance);
                btn.disabled = false;
                btn.classList.remove('opacity-50');
            } finally {
                loading.classList.add('hidden');
            }
        }

        function pcm16ToWav(pcmData, sampleRate) {
            const numChannels = 1;
            const bitsPerSample = 16;
            const byteRate = sampleRate * numChannels * bitsPerSample / 8;
            const blockAlign = numChannels * bitsPerSample / 8;
            const wavHeader = new ArrayBuffer(44);
            const view = new DataView(wavHeader);

            const writeString = (view, offset, string) => {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            };

            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + pcmData.length, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, byteRate, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, bitsPerSample, true);
            writeString(view, 36, 'data');
            view.setUint32(40, pcmData.length, true);

            const wavBody = new Uint8Array(wavHeader.byteLength + pcmData.length);
            wavBody.set(new Uint8Array(wavHeader), 0);
            wavBody.set(pcmData, wavHeader.byteLength);

            return wavBody;
        }

        // --- Knowledge Hub Logic ---
        const knowledgeData = {
            antibiotics: [
                {
                    title: "ที่มาและปัญหา: วิกฤตเชื้อดื้อยา (AMR)",
                    icon: "fa-exclamation-triangle",
                    color: "text-red-500",
                    content: `
                        <div class="mb-3">
                            <p class="mb-3">
                                การใช้ยาปฏิชีวนะมากเกินความจำเป็น (Overuse) หรือใช้ผิดวิธี (Misuse) ก่อให้เกิดวิกฤต <strong>"เชื้อดื้อยาต้านจุลชีพ" (AMR)</strong> ซึ่งกระทบต่อสุขภาพสัตว์ สิ่งแวดล้อม และมนุษย์ ภายใต้แนวคิด "สุขภาพหนึ่งเดียว" (One Health)
                            </p>
                            <div class="bg-red-50 p-4 rounded-md border-l-4 border-red-500 text-sm">
                                <strong>ข้อควรระวัง:</strong> ยาปฏิชีวนะฆ่าเชื้อแบคทีเรียเท่านั้น <em>ไม่ฆ่าไวรัส ไม่ลดการอักเสบ และไม่ลดไข้</em> การใช้ผิดวัตถุประสงค์เร่งให้เกิดการดื้อยาเร็วขึ้น
                            </div>
                        </div>
                    `
                },
                {
                    title: "1. การปฏิรูปการจัดการฟาร์ม (Fundamental Management)",
                    icon: "fa-shield-alt",
                    color: "text-blue-500",
                    content: `
                        <div class="mb-4">
                            <p class="mb-4">กุญแจสำคัญคือการปรับ Mindset โดยใช้ยาปฏิชีวนะเป็น "ทางเลือกสุดท้าย" และเน้นการจัดการองค์รวม:</p>
                            <ul class="list-disc pl-5 space-y-2">
                                <li><strong>ความปลอดภัยทางชีวภาพ (Biosecurity):</strong> ใช้ระบบ "เข้าหมด-ออกหมด" (All-in All-out) เพื่อตัดวงจรโรค</li>
                                <li><strong>การจัดการสิ่งแวดล้อม:</strong> ควบคุมความเครียดสัตว์ โดยเฉพาะก๊าซแอมโมเนีย (ไม่ควรเกิน 30-50 ppm) ซึ่งส่งผลต่อการกินอาหาร</li>
                                <li><strong>โภชนาการและน้ำ:</strong> อาหารครบถ้วนและน้ำสะอาดคือพื้นฐานของระบบเมตาบอลิซึม</li>
                                <li><strong>สุขภาพลำไส้:</strong> เมื่อพื้นฐานดี ระบบนิเวศในลำไส้และภูมิคุ้มกันจะทำงานได้เต็มประสิทธิภาพ</li>
                            </ul>
                        </div>
                    `
                },
                {
                    title: "2. นวัตกรรมผลิตภัณฑ์ทดแทน (Alternative Nutraceuticals)",
                    icon: "fa-seedling",
                    color: "text-green-500",
                    content: `
                         <div class="mb-4">
                            <p class="mb-4">การใช้ "เภสัชโภชนภัณฑ์" เพื่อป้องกันโรค (Prophylaxis) ทดแทนยาปฏิชีวนะ:</p>
                            <div class="grid md:grid-cols-2 gap-4">
                                <div class="bg-green-50 p-3 rounded">
                                <h4 class="font-bold text-green-700">2.1 วัคซีน (Vaccines)</h4>
                                <p class="text-sm">ป้องกันที่ต้นเหตุ กระตุ้นภูมิคุ้มกันจำเพาะ ลดการติดเชื้อ</p>
                                </div>
                                <div class="bg-blue-50 p-3 rounded">
                                <h4 class="font-bold text-blue-700">2.2 Probiotics & Prebiotics</h4>
                                <p class="text-sm">ปรับสมดุลจุลินทรีย์ลำไส้ และส่งเสริมการเติบโตของจุลินทรีย์ดี</p>
                                </div>
                                <div class="bg-yellow-50 p-3 rounded">
                                <h4 class="font-bold text-yellow-700">2.3 สมุนไพร (Phytogenics)</h4>
                                <p class="text-sm">เพิ่มความน่ากิน, กระตุ้นภูมิคุ้มกัน, ต้านเชื้อแบคทีเรียและลดอักเสบ</p>
                                </div>
                                <div class="bg-purple-50 p-3 rounded">
                                <h4 class="font-bold text-purple-700">2.4 เทคโนโลยีชีวภาพ</h4>
                                <p class="text-sm">วัคซีนเฉพาะถิ่น (Autogenous), แบคทีริโอเฟจ (Phage Therapy), กรดอินทรีย์</p>
                                </div>
                            </div>
                        </div>
                    `
                },
                {
                    title: "3. หลักฐานเชิงประจักษ์ (Scientific Evidence)",
                    icon: "fa-book-open",
                    color: "text-indigo-500",
                    content: `
                        <div class="mb-3">
                            <p class="mb-3">ผลการวิจัยยืนยันประสิทธิภาพของสารทดแทน:</p>
                            <ul class="list-disc pl-5 mb-4 space-y-2">
                                <li><strong>Meta-analysis (Gabler N., 2017):</strong> พบว่า Probiotics และสมุนไพร ช่วยเพิ่มอัตราการเจริญเติบโต (ADG) อย่างมีนัยสำคัญ</li>
                                <li><strong>กรณีศึกษาไทย (Yamsakul et al., 2016):</strong> เปรียบเทียบ "สารสกัดข่า" vs "ยา Colistin" ในสุกร</li>
                            </ul>
                            <div class="overflow-x-auto">
                                <table class="min-w-full text-sm text-left text-gray-500 border rounded-lg">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                                    <tr>
                                    <th class="px-6 py-3">กลุ่มการทดลอง</th>
                                    <th class="px-6 py-3">ADG (กรัม/วัน)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="bg-white border-b">
                                    <td class="px-6 py-4">กลุ่มควบคุม (ไม่ใส่ยา/สารเสริม)</td>
                                    <td class="px-6 py-4">491.79</td>
                                    </tr>
                                    <tr class="bg-green-50 border-b font-semibold">
                                    <td class="px-6 py-4">สารสกัดข่า 2 กก./ตัน</td>
                                    <td class="px-6 py-4 text-green-700">595.23</td>
                                    </tr>
                                    <tr class="bg-white border-b">
                                    <td class="px-6 py-4">ยาปฏิชีวนะ Colistin 150 ppm</td>
                                    <td class="px-6 py-4">598.01</td>
                                    </tr>
                                </tbody>
                                </table>
                            </div>
                            <p class="mt-2 text-sm text-gray-600">สรุป: กลุ่มสารสกัดข่าให้ผลดีเทียบเท่าการใช้ยาปฏิชีวนะ และดีกว่ากลุ่มควบคุมชัดเจน</p>
                        </div>
                    `
                }
            ],
            ssuis: [
                {
                    title: "ความสำคัญและผลกระทบ",
                    icon: "fa-heartbeat",
                    color: "text-red-600",
                    content: `
                        <div>
                            <p>เชื้อ <em>Streptococcus suis</em> (S. suis) เป็นแบคทีเรียก่อโรควิกฤตในอุตสาหกรรมสุกร:</p>
                            <ul class="list-disc pl-5 mt-2">
                                <li><strong>ด้านเศรษฐกิจ:</strong> เพิ่มต้นทุนการรักษาและสูญเสียผลผลิต</li>
                                <li><strong>ด้านสาธารณสุข:</strong> เป็นโรคสัตว์สู่คน (Zoonosis) ที่อันตรายถึงชีวิต ก่อให้เกิดหูดับหรือเยื่อหุ้มสมองอักเสบในคน</li>
                            </ul>
                        </div>
                    `
                },
                {
                    title: "1. ลักษณะเชื้อและการระบาด (Etiology & Epidemiology)",
                    icon: "fa-microscope",
                    color: "text-blue-600",
                    content: `
                        <div>
                            <h4 class="font-bold text-gray-800 mb-2">ลักษณะเชื้อ</h4>
                            <p class="mb-2">แบคทีเรียแกรมบวก รูปร่างกลม (Coccus) มีแคปซูล (ปัจจัยความรุนแรง) ไม่เคลื่อนที่ พบ 29 ซีโรไทป์ โดย <strong>Serotype 2</strong> ก่อโรครุนแรงที่สุด</p>
                            
                            <h4 class="font-bold text-gray-800 mb-2 mt-4">การระบาด</h4>
                            <p className="mb-2">สุกรในฟาร์มส่วนใหญ่เป็นพาหะ (Carrier) กลุ่มเสี่ยงคือสุกรหย่านมและอนุบาล (5-10 สัปดาห์)</p>
                            <ul class="list-disc pl-5 bg-gray-50 p-3 rounded">
                                <li><strong>ปัจจัยโน้มนำ:</strong> ความเครียด, การเลี้ยงหนาแน่น, อากาศถ่ายเทไม่ดี, ภูมิคุ้มกันตก</li>
                                <li><strong>ช่องทางแพร่เชื้อ:</strong> การสัมผัสจมูกต่อจมูก, การกิน, หรือผ่านอุปกรณ์ปนเปื้อน</li>
                            </ul>
                        </div>
                    `
                },
                {
                    title: "2. อาการและรอยโรค (Clinical Signs & Pathology)",
                    icon: "fa-stethoscope",
                    color: "text-purple-600",
                    content: `
                        <div>
                            <h4 class="font-bold text-gray-800">อาการทางคลินิก</h4>
                            <p class="mb-2">ไข้สูง (40.5-41.5 °C), ตายเฉียบพลัน</p>
                            <ul class="list-disc pl-5 mb-4">
                                <li><strong>ระบบประสาท:</strong> ชักเกร็ง, นอนตะกุยขา, คอแข็งเกร็ง (Meningitis)</li>
                                <li><strong>ระบบข้อ:</strong> ข้อบวมอักเสบ, ขาเจ็บ เดินกะเผลก</li>
                            </ul>

                            <h4 class="font-bold text-gray-800">รอยโรค (เมื่อผ่าซาก)</h4>
                            <ul class="list-disc pl-5">
                                <li>เยื่อหุ้มสมองขุ่นหนา มีหนอง</li>
                                <li>ข้อบวม ภายในมีหนอง</li>
                                <li><strong>Fibrinous Polyserositis:</strong> มีไฟบรินปกคลุมอวัยวะภายใน เช่น หัวใจ ปอด</li>
                            </ul>
                        </div>
                    `
                },
                {
                    title: "3. การรักษาและควบคุม (Treatment & Control)",
                    icon: "fa-pills",
                    color: "text-green-600",
                    content: `
                        <div class="space-y-4">
                            <div class="border-l-4 border-blue-500 pl-4">
                                <h4 class="font-bold text-gray-800">การวินิจฉัย</h4>
                                <p class="text-sm">ดูประวัติอาการ + รอยโรค และยืนยันผลด้วยแล็บ (เพาะเชื้อ หรือ PCR)</p>
                            </div>
                            
                            <div class="border-l-4 border-green-500 pl-4">
                                <h4 class="font-bold text-gray-800">การรักษา</h4>
                                <p class="text-sm">ใช้ยาปฏิชีวนะกลุ่ม Beta-lactams (เช่น Penicillin, Amoxicillin) ตามผลทดสอบความไวของเชื้อ</p>
                            </div>

                            <div class="border-l-4 border-orange-500 pl-4">
                                <h4 class="font-bold text-gray-800">การป้องกัน</h4>
                                <p class="text-sm">จัดการ Biosecurity, ลดความเครียด, ใช้ยาฆ่าเชื้อที่มีประสิทธิภาพ และพิจารณาการใช้วัคซีน</p>
                            </div>
                        </div>
                    `
                }
            ],
            gender_amr: [
                {
                    title: "บทสรุป (Executive Summary)",
                    icon: "fa-clipboard-list",
                    color: "text-red-600",
                    content: `
                        <div class="space-y-3">
                            <p><strong>แก่นของปัญหา:</strong> เพศสภาพและความไม่เท่าเทียมทางสังคมไม่ใช่เรื่องไกลตัว แต่เป็น "ตัวเร่ง" ปัญหาการดื้อยาต้านจุลชีพ (AMR)</p>
                            <ul class="list-disc pl-5 space-y-1">
                                <li><strong>ผู้หญิง:</strong> แบกรับความเสี่ยงสูงกว่าในฐานะผู้ดูแลหลัก บุคลากรทางการแพทย์ด่านหน้า และเกษตรกรรายย่อย แต่กลับมีอำนาจตัดสินใจน้อย</li>
                                <li><strong>ผู้ชาย:</strong> พฤติกรรมที่มองว่าการไปหาหมอคือความอ่อนแอ นำไปสู่การวินิจฉัยโรคช้าและการใช้ยาผิดวิธี</li>
                                <li><strong>นโยบาย:</strong> ขาดมุมมองทางเพศในการกำหนดนโยบายระดับโลก ทำให้มาตรการแก้ปัญหา AMR ยังไม่ครอบคลุม</li>
                            </ul>
                        </div>
                    `
                },
                {
                    title: "1. สถานะข้อมูลและการวิจัย (Data & Research)",
                    icon: "fa-chart-pie",
                    color: "text-blue-600",
                    content: `
                        <div class="bg-blue-50 p-3 rounded-lg border-l-4 border-blue-500 mb-3">
                            <p><strong>"การแยกแยะข้อมูลตามเพศ คือก้าวแรกของการแก้ปัญหาที่ตรงจุด"</strong></p>
                        </div>
                        <ul class="list-disc pl-5 space-y-2">
                            <li><strong>สถานการณ์ปัจจุบัน:</strong> รายงานจากระบบ GLASS (ปี 2021) พบว่าจาก 70 ประเทศ มี 53 ประเทศที่ส่งข้อมูลผลทดสอบความไวของยา (AST) แต่มีเพียง "บางส่วน" เท่านั้นที่แยกข้อมูลตามเพศ</li>
                            <li><strong>สิ่งที่ต้องทำ:</strong> ต้องวิเคราะห์แผนปฏิบัติการระดับชาติ (National Action Plans) ใหม่ เพื่อบูรณาการมิติทางเพศเข้าไปอย่างจริงจัง ไม่ใช่แค่มองภาพรวม</li>
                        </ul>
                    `
                },
                {
                    title: "2. บริบทครัวเรือนและชุมชน (Household & Community)",
                    icon: "fa-home",
                    color: "text-green-600",
                    content: `
                        <div class="mb-3">
                            <p class="mb-2"><strong>"บทบาททางเพศกำหนดความเสี่ยงตั้งแต่ในบ้าน"</strong></p>
                            <h4 class="font-bold text-green-700 mt-3">👩‍🦰 ความเสี่ยงของผู้หญิง</h4>
                            <ul class="list-disc pl-5 space-y-1">
                                <li><strong>ผู้ดูแล (Caregiver):</strong> ใกล้ชิดผู้ป่วยมากที่สุด จึงเสี่ยงรับเชื้อมากที่สุด</li>
                                <li><strong>อำนาจการเงิน:</strong> แม้จะมีความรู้เรื่องยา แต่หากไม่มีเงิน ก็ไม่สามารถเข้าถึงการรักษาหรือยาที่มีคุณภาพได้</li>
                                <li><strong>สุขอนามัย (WASH):</strong>
                                    <ul class="list-circle pl-5 mt-1 text-sm text-gray-600">
                                        <li>รับผิดชอบการตักน้ำ = สัมผัสแหล่งน้ำปนเปื้อน</li>
                                        <li>สุขอนามัยไม่ดี = เสี่ยงติดเชื้อทางเดินปัสสาวะ (UTIs) สูง โดยเฉพาะช่วงมีประจำเดือน</li>
                                        <li>การทำอาหาร = สูดดมควันและสัมผัสเชื้อจากการเตรียมเนื้อสัตว์</li>
                                    </ul>
                                </li>
                            </ul>
                            <h4 class="font-bold text-green-700 mt-3">💊 พฤติกรรมการใช้ยา</h4>
                            <p class="text-sm">ความไม่เท่าเทียมทำให้ผู้หญิงอาจตัดสินใจ "รักษาเอง" เก็บยาไว้กินทีหลัง หรือแบ่งปันยาปฏิชีวนะให้คนอื่นแทนการไปพบแพทย์</p>
                        </div>
                    `
                },
                {
                    title: "3. บริบทในสถานพยาบาล (Healthcare Settings)",
                    icon: "fa-hospital",
                    color: "text-purple-600",
                    content: `
                        <div class="space-y-3">
                            <p><strong>"อคติทางเพศในระบบหมอและคนไข้ ส่งผลต่อการรักษา"</strong></p>
                            
                            <div class="bg-purple-50 p-3 rounded">
                                <h4 class="font-bold text-purple-700">👩‍⚕️ บุคลากรทางการแพทย์</h4>
                                <p class="text-sm">ด่านหน้า: ผู้หญิงคือ 70% ของบุคลากรทางการแพทย์ทั่วโลก คือกลุ่มเสี่ยงสูงสุดที่ต้องปะทะกับเชื้อดื้อยา</p>
                            </div>

                            <h4 class="font-bold text-gray-800">🏥 ผู้ป่วยและการรักษา</h4>
                            <ul class="list-disc pl-5 space-y-1 text-sm">
                                <li><strong>ผู้ชาย:</strong> มักไม่กล้ามาหาหมอเพราะกลัวดูอ่อนแอ → ผลลัพธ์: มาช้า, อาการหนัก, ชอบยาแรงๆ เพื่อให้หายเร็ว</li>
                                <li><strong>ผู้หญิง:</strong> ถูกตีตราในบางโรค (เช่น UTIs) ทำให้ไม่กล้ามาหาหมอ</li>
                                <li><strong>อคติการจ่ายยา:</strong>
                                    <ul class="list-disc pl-5 mt-1 text-gray-600">
                                        <li>ผู้หญิงมีแนวโน้มได้รับยาปฏิชีวนะมากกว่าผู้ชายถึง 27% ตลอดช่วงชีวิต</li>
                                        <li>ใน ICU ผู้หญิงเสี่ยงได้รับการรักษาภาวะช็อกจากการติดเชื้อ (septic shock) ล่าช้ากว่าผู้ชาย</li>
                                    </ul>
                                </li>
                            </ul>
                        </div>
                    `
                },
                {
                    title: "4. ภาคเกษตรกรรม (Agriculture)",
                    icon: "fa-tractor",
                    color: "text-yellow-600",
                    content: `
                        <div class="space-y-3">
                            <div class="bg-yellow-50 p-3 rounded border-l-4 border-yellow-500">
                                <p><strong>"ผู้หญิงคือกระดูกสันหลังที่ถูกมองข้ามในภาคปศุสัตว์"</strong></p>
                            </div>
                            
                            <h4 class="font-bold text-yellow-800">👩‍🌾 ความจริงของเกษตรกรหญิง</h4>
                            <ul class="list-disc pl-5 text-sm space-y-1">
                                <li><strong>จำนวน:</strong> ผู้หญิงชนบท 400 ล้านคน คือผู้เลี้ยงปศุสัตว์รายย่อย</li>
                                <li><strong>หน้าที่:</strong> ดูแลสัตว์ป่วย (เสี่ยงรับเชื้อ) ในขณะที่ผู้ชายมักทำหน้าที่ฆ่าสัตว์</li>
                                <li><strong>อคติโครงการ:</strong> โครงการรณรงค์ AMR มักมุ่งไปที่ "หัวหน้าครอบครัวชาย" ทำให้ข้อมูลไปไม่ถึงผู้หญิงที่เลี้ยงสัตว์จริงๆ</li>
                            </ul>

                            <h4 class="font-bold text-red-700">🚧 อุปสรรคและผลกระทบ</h4>
                            <ul class="list-disc pl-5 text-sm space-y-1">
                                <li><strong>เข้าถึงยาก:</strong> ขาดโอกาสเข้าถึงสัตวแพทย์ สินเชื่อ และการฝึกอบรม (บางที่ต้องขออนุญาตสามี)</li>
                                <li><strong>วงจรความจน:</strong> สัตว์ป่วยตาย = รายได้หาย = ไม่มีเงินรักษาตัวเอง</li>
                                <li><strong>Impact:</strong> หากผู้หญิงเข้าถึงทรัพยากรเท่าเทียมกัน ผลผลิตจะเพิ่ม 20-30% และลดจำนวนผู้หิวโหยได้ถึง 100-140 ล้านคน</li>
                            </ul>
                        </div>
                    `
                },
                {
                    title: "5. การตัดสินใจและนโยบาย (Governance & Policy)",
                    icon: "fa-balance-scale",
                    color: "text-indigo-600",
                    content: `
                        <div class="space-y-3">
                            <p><strong>"โต๊ะประชุมที่ขาดความสมดุล นำไปสู่นโยบายที่แก้ปัญหาได้ไม่ครบ"</strong></p>
                            
                            <div class="grid grid-cols-2 gap-2">
                                <div class="bg-gray-100 p-2 rounded text-center">
                                    <p class="text-2xl font-bold text-indigo-600">70%</p>
                                    <p class="text-xs">ผู้นำองค์กรสุขภาพโลกเป็นชาย</p>
                                </div>
                                <div class="bg-gray-100 p-2 rounded text-center">
                                    <p class="text-2xl font-bold text-pink-600">5%</p>
                                    <p class="text-xs">ผู้นำหญิงจากประเทศรายได้ต่ำ-ปานกลาง</p>
                                </div>
                            </div>

                            <div class="bg-indigo-50 p-3 rounded border border-indigo-200">
                                <h4 class="font-bold text-indigo-800 mb-2">✅ ข้อเสนอแนะจาก WHO</h4>
                                <ul class="list-check pl-5 text-sm space-y-1">
                                    <li><i class="fas fa-check text-green-500 mr-1"></i> <strong>ต้องมีที่นั่ง:</strong> เพิ่มสัดส่วนผู้หญิงในกลไกการประสานงาน AMR และคณะทำงานเทคนิค</li>
                                    <li><i class="fas fa-check text-green-500 mr-1"></i> <strong>ต้องมีผู้เชี่ยวชาญ:</strong> ดึงผู้เชี่ยวชาญด้านเพศสภาพ (Gender Experts) เข้าร่วมทีมวางแผนยุทธศาสตร์ระดับชาติ</li>
                                </ul>
                            </div>
                        </div>
                    `
                }
            ]
        };

        let currentTab = 'antibiotics';
        let openAccordionIndex = null;

        function switchTab(tab) {
            currentTab = tab;
            openAccordionIndex = null; // Reset accordion
            renderKnowledgeUI();
        }

        function toggleAccordion(index) {
            openAccordionIndex = openAccordionIndex === index ? null : index;
            renderKnowledgeUI();
        }

        function renderKnowledgeUI() {
            // Update Tabs
            const tabAntibiotics = document.getElementById('tab-antibiotics');
            const tabSsuis = document.getElementById('tab-ssuis');
            const tabGender = document.getElementById('tab-gender');

            const inactiveClass = "flex-1 py-3 px-4 rounded-md text-sm font-semibold transition-all duration-200 text-gray-600 hover:text-gray-800";
            const activeClassBase = "flex-1 py-3 px-4 rounded-md text-sm font-semibold transition-all duration-200 bg-white shadow-sm";

            // Reset all
            tabAntibiotics.className = inactiveClass;
            tabSsuis.className = inactiveClass;
            tabGender.className = inactiveClass;

            // Activate specific
            if (currentTab === 'antibiotics') {
                tabAntibiotics.className = activeClassBase + " text-indigo-700";
                document.getElementById('section-title').innerText = "นวัตกรรมลดการใช้ยาปฏิชีวนะ";
                document.getElementById('section-subtitle').innerText = "แนวทางเลือกใหม่เพื่อความยั่งยืนในอุตสาหกรรมปศุสัตว์";
            } else if (currentTab === 'ssuis') {
                tabSsuis.className = activeClassBase + " text-red-700";
                document.getElementById('section-title').innerText = "โรคสเตรปโตคอคคัส ซูอิส (S. suis)";
                document.getElementById('section-subtitle').innerText = "ระบาดวิทยา อาการ และมาตรการควบคุมโรค";
            } else if (currentTab === 'gender_amr') {
                tabGender.className = activeClassBase + " text-purple-700";
                document.getElementById('section-title').innerText = "ความเสมอภาคทางเพศและวิกฤตเชื้อดื้อยา";
                document.getElementById('section-subtitle').innerText = "บทบาททางสังคมที่ส่งผลต่อการเกิดและแพร่กระจายของ AMR";
            }

            // Render Accordion
            const container = document.getElementById('accordion-container');
            container.innerHTML = '';

            const items = knowledgeData[currentTab];
            items.forEach((item, index) => {
                const isOpen = openAccordionIndex === index;
                const div = document.createElement('div');
                div.className = "border border-gray-200 rounded-lg mb-3 overflow-hidden shadow-sm hover:shadow-md transition-shadow duration-200 bg-white";

                div.innerHTML = `
                    <button onclick="toggleAccordion(${index})"
                        class="w-full flex items-center justify-between p-4 text-left transition-colors duration-200 ${isOpen ? 'bg-blue-50 text-blue-700' : 'bg-white text-gray-700 hover:bg-gray-50'}">
                        <div class="flex items-center gap-3">
                            <i class="fas ${item.icon} text-lg ${isOpen ? 'text-blue-600' : 'text-gray-400'}"></i>
                            <span class="font-semibold text-base md:text-lg">${item.title}</span>
                        </div>
                        <i class="fas ${isOpen ? 'fa-chevron-up' : 'fa-chevron-down'} ${isOpen ? 'text-blue-600' : 'text-gray-400'}"></i>
                    </button>
                    ${isOpen ? `
                        <div class="p-5 bg-white text-gray-600 leading-relaxed border-t border-gray-100 animate-fadeIn">
                            ${item.content}
                        </div>
                    ` : ''}
                `;
                container.appendChild(div);
            });
        }

        // Initialize Knowledge UI
        renderKnowledgeUI();

        // --- Timer Logic ---
        function startTimer() {
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                seconds++;
                totalSeconds++;
                updateTimeDisplay();
            }, 1000);
        }

        function updateTimeDisplay() {
            const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
            const secs = (seconds % 60).toString().padStart(2, '0');
            timeDisplay.innerText = `${mins}:${secs}`;
        }

        function resetLevelStats() {
            moves = 0;
            seconds = 0;
            matchedPairs = 0;
            gameStarted = false;
            clearInterval(timerInterval);

            movesDisplay.innerText = '0';
            timeDisplay.innerText = '00:00';

            [hasFlippedCard, lockBoard] = [false, false];
            [firstCard, secondCard] = [null, null];
        }

        // --- Game Flow Control ---
        function levelComplete() {
            clearInterval(timerInterval);

            document.getElementById('modal-level-num').innerText = currentLevelIndex + 1;
            document.getElementById('level-time').innerText = timeDisplay.innerText;
            document.getElementById('level-moves').innerText = moves;

            if (currentLevelIndex < levelsData.length - 1) {
                document.getElementById('modal-msg').innerText = "เยี่ยมมาก! เตรียมตัวสำหรับด่านถัดไป";
                levelModal.classList.remove('hidden');
            } else {
                showVictory();
            }
        }

        function nextLevel(isLocalAction = true) {
            if (isLocalAction && isMultiplayer) sendGameAction('NEXT_LEVEL', {});
            levelModal.classList.add('hidden');
            initGame(currentLevelIndex + 1);
        }

        function showVictory() {
            const mins = Math.floor(totalSeconds / 60).toString().padStart(2, '0');
            const secs = (totalSeconds % 60).toString().padStart(2, '0');
            document.getElementById('total-time').innerText = `${mins}:${secs}`;

            victoryModal.classList.remove('hidden');
        }

        function restartGame(isLocalAction = true) {
            if (isLocalAction && isMultiplayer) sendGameAction('RESTART', {});
            victoryModal.classList.add('hidden');
            welcomeScreen.classList.remove('hidden'); // Show Welcome screen on full restart
            gameContainer.classList.add('hidden');
            totalSeconds = 0;
        }

        // --- MQTT Functions ---
        function openMultiplayerModal() {
            if (isMultiplayer) {
                if (confirm('ต้องการตัดการเชื่อมต่อหรือไม่?')) {
                    disconnectMQTT();
                }
            } else {
                document.getElementById('multiplayer-modal').classList.remove('hidden');
            }
        }

        function connectMQTT() {
            const input = document.getElementById('room-id-input').value.trim();
            if (!input) return alert("กรุณาใส่ชื่อห้อง");

            roomId = input;
            document.getElementById('multiplayer-modal').classList.add('hidden');

            const btn = document.getElementById('btn-multiplayer');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> กำลังเชื่อมต่อ...';

            mqttClient = new Paho.MQTT.Client("broker.emqx.io", 8083, myClientId);
            mqttClient.onConnectionLost = onConnectionLost;
            mqttClient.onMessageArrived = onMessageArrived;

            mqttClient.connect({
                onSuccess: onConnect,
                onFailure: onFailure,
                keepAliveInterval: 30
            });
        }

        function onConnect() {
            console.log("MQTT Connected");
            isMultiplayer = true;
            const btn = document.getElementById('btn-multiplayer');
            btn.className = "bg-green-100 hover:bg-green-200 text-green-700 px-3 py-1 rounded-full shadow-sm border border-green-200 flex items-center transition-colors";
            btn.innerHTML = `<i class="fas fa-circle text-xs text-green-500 mr-2"></i> ห้อง: ${roomId}`;
            mqttClient.subscribe(`ssuis-game/${roomId}/action`);
        }

        function onFailure(responseObject) {
            alert("เชื่อมต่อล้มเหลว: " + responseObject.errorMessage);
            resetMultiplayerUI();
        }

        function onConnectionLost(responseObject) {
            if (responseObject.errorCode !== 0) {
                console.log("Connection Lost: " + responseObject.errorMessage);
            }
            resetMultiplayerUI();
        }

        function disconnectMQTT() {
            if (mqttClient) {
                mqttClient.disconnect();
            }
            resetMultiplayerUI();
        }

        function resetMultiplayerUI() {
            isMultiplayer = false;
            const btn = document.getElementById('btn-multiplayer');
            btn.className = "bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-1 rounded-full shadow-sm border border-blue-200 flex items-center transition-colors";
            btn.innerHTML = `<i class="fas fa-users mr-2"></i> เล่นกับเพื่อน`;
        }

        function sendGameAction(type, payload) {
            if (!mqttClient || !isMultiplayer) return;

            const message = new Paho.MQTT.Message(JSON.stringify({
                sender: myClientId,
                type: type,
                payload: payload
            }));
            message.destinationName = `ssuis-game/${roomId}/action`;
            mqttClient.send(message);
        }

        function onMessageArrived(message) {
            try {
                const data = JSON.parse(message.payloadString);
                if (data.sender === myClientId) return;

                console.log("Received:", data);

                switch (data.type) {
                    case 'FLIP':
                        handleRemoteFlip(data.payload.cardIndex);
                        break;
                    case 'START_TIMER':
                        if (!gameStarted) {
                            startTimer();
                            gameStarted = true;
                        }
                        break;
                    case 'NEXT_LEVEL':
                        nextLevel(false);
                        break;
                    case 'RESTART':
                        restartGame(false);
                        break;
                }
            } catch (e) {
                console.error("Msg Parse Error", e);
            }
        }

        function handleRemoteFlip(index) {
            const cardContainer = gameBoard.children[index];
            if (cardContainer) {
                const card = cardContainer.querySelector('.card');
                if (card && !card.classList.contains('flipped')) {
                    flipCard(card, false);
                }
            }
        }
    </script>
</body>

</html>
